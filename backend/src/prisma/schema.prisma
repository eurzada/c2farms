generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password_hash String
  name          String
  role          String         @default("farm_manager")
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  farm_roles    UserFarmRole[]

  @@map("users")
}

model Farm {
  id         String         @id @default(uuid())
  name       String
  created_at DateTime       @default(now())
  updated_at DateTime       @updatedAt
  user_roles UserFarmRole[]

  @@map("farms")
}

model UserFarmRole {
  id      String @id @default(uuid())
  user_id String
  farm_id String
  role    String @default("admin")
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  farm    Farm   @relation(fields: [farm_id], references: [id], onDelete: Cascade)

  @@unique([user_id, farm_id])
  @@map("user_farm_roles")
}

model Assumption {
  id           String    @id @default(uuid())
  farm_id      String
  fiscal_year  Int
  start_month  String    @default("Nov")
  end_month    String    @default("Oct")
  total_acres  Float
  crops_json   Json      @default("[]")
  bins_json    Json      @default("[]")
  is_frozen    Boolean   @default(false)
  frozen_at    DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  @@unique([farm_id, fiscal_year])
  @@map("assumptions")
}

model MonthlyData {
  id            String   @id @default(uuid())
  farm_id       String
  fiscal_year   Int
  month         String
  type          String   // 'per_unit' or 'accounting'
  data_json     Json     @default("{}")
  is_actual     Boolean  @default(false)
  comments_json Json     @default("{}")
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([farm_id, fiscal_year, month, type])
  @@map("monthly_data")
}

model MonthlyDataFrozen {
  id            String   @id @default(uuid())
  farm_id       String
  fiscal_year   Int
  month         String
  type          String
  data_json     Json     @default("{}")
  is_actual     Boolean  @default(false)
  comments_json Json     @default("{}")
  created_at    DateTime @default(now())

  @@unique([farm_id, fiscal_year, month, type])
  @@map("monthly_data_frozen")
}

model FinancialCategory {
  id            Int     @id
  code          String  @unique
  display_name  String
  parent_id     Int?
  path          String
  level         Int
  sort_order    Int
  category_type String
  parent        FinancialCategory?  @relation("CategoryParent", fields: [parent_id], references: [id])
  children      FinancialCategory[] @relation("CategoryParent")

  @@map("financial_categories")
}

model QbCategoryMapping {
  id              String @id @default(uuid())
  farm_id         String
  qb_account_name String
  category_code   String
  weight          Float  @default(1.0)

  @@unique([farm_id, qb_account_name])
  @@map("qb_category_mappings")
}

model QbToken {
  id            String   @id @default(uuid())
  farm_id       String   @unique
  access_token  String
  refresh_token String
  realm_id      String
  expires_at    DateTime

  @@map("qb_tokens")
}

model FarmCategory {
  id            String         @id @default(uuid())
  farm_id       String
  code          String
  display_name  String
  parent_id     String?
  path          String
  level         Int
  sort_order    Int
  category_type String         // REVENUE, INPUT, LPM, LBF, INSURANCE
  is_active     Boolean        @default(true)
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt

  parent        FarmCategory?  @relation("FarmCategoryParent", fields: [parent_id], references: [id])
  children      FarmCategory[] @relation("FarmCategoryParent")
  gl_accounts   GlAccount[]

  @@unique([farm_id, code])
  @@map("farm_categories")
}

model GlAccount {
  id             String          @id @default(uuid())
  farm_id        String
  account_number String
  account_name   String
  category_id    String?
  qb_account_id  String?
  is_active      Boolean         @default(true)
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt

  category       FarmCategory?   @relation(fields: [category_id], references: [id])
  actuals        GlActualDetail[]

  @@unique([farm_id, account_number])
  @@map("gl_accounts")
}

model GlActualDetail {
  id            String    @id @default(uuid())
  farm_id       String
  fiscal_year   Int
  month         String
  gl_account_id String
  amount        Float
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  gl_account    GlAccount @relation(fields: [gl_account_id], references: [id])

  @@unique([farm_id, fiscal_year, month, gl_account_id])
  @@map("gl_actual_details")
}

model FarmInvite {
  id         String   @id @default(uuid())
  farm_id    String
  email      String
  role       String   @default("viewer")
  invited_by String
  status     String   @default("pending") // pending, accepted, expired
  created_at DateTime @default(now())
  expires_at DateTime

  @@unique([farm_id, email])
  @@map("farm_invites")
}

model OperationalData {
  id           String   @id @default(uuid())
  farm_id      String
  fiscal_year  Int
  month        String
  metric       String   // 'labour_hours', 'equipment_hours', 'fuel_litres'
  budget_value Float    @default(0)
  actual_value Float    @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([farm_id, fiscal_year, month, metric])
  @@map("operational_data")
}

model AiConversation {
  id         String      @id @default(uuid())
  farm_id    String
  user_id    String
  title      String?
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  messages   AiMessage[]

  @@index([farm_id])
  @@map("ai_conversations")
}

model AiMessage {
  id              String         @id @default(uuid())
  conversation_id String
  role            String         // user, assistant, system
  content         String
  context_json    Json?
  metadata_json   Json?
  created_at      DateTime       @default(now())
  conversation    AiConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@map("ai_messages")
}

// ─── Inventory Module (Grain Control Centre) ────────────────────────

model Commodity {
  id         String          @id @default(uuid())
  farm_id    String
  name       String
  code       String
  lbs_per_bu Float
  created_at DateTime        @default(now())
  updated_at DateTime        @updatedAt
  bins       InventoryBin[]
  bin_counts BinCount[]
  contracts  Contract[]

  @@unique([farm_id, code])
  @@map("commodities")
}

model InventoryLocation {
  id          String            @id @default(uuid())
  farm_id     String
  name        String
  code        String
  cluster     String            @default("individual") // central, individual, transit
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  bins        InventoryBin[]
  submissions CountSubmission[]

  @@unique([farm_id, code])
  @@map("inventory_locations")
}

model InventoryBin {
  id          String            @id @default(uuid())
  farm_id     String
  location_id String
  bin_number  String
  bin_type    String            @default("hopper") // hopper, flat, temporary
  capacity_bu Float?
  commodity_id String?
  notes       String?
  is_active   Boolean           @default(true)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  location    InventoryLocation @relation(fields: [location_id], references: [id], onDelete: Cascade)
  commodity   Commodity?        @relation(fields: [commodity_id], references: [id])
  bin_counts  BinCount[]

  @@unique([farm_id, location_id, bin_number])
  @@map("inventory_bins")
}

model CountPeriod {
  id          String            @id @default(uuid())
  farm_id     String
  period_date DateTime          @db.Date
  crop_year   Int
  status      String            @default("open") // open, closed
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  bin_counts  BinCount[]
  submissions CountSubmission[]

  @@unique([farm_id, period_date])
  @@map("count_periods")
}

model CountSubmission {
  id              String            @id @default(uuid())
  farm_id         String
  count_period_id String
  location_id     String
  submitted_by    String?
  status          String            @default("draft") // draft, submitted, approved, rejected
  notes           String?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  count_period    CountPeriod       @relation(fields: [count_period_id], references: [id], onDelete: Cascade)
  location        InventoryLocation @relation(fields: [location_id], references: [id], onDelete: Cascade)

  @@unique([farm_id, count_period_id, location_id])
  @@map("count_submissions")
}

model BinCount {
  id              String       @id @default(uuid())
  farm_id         String
  count_period_id String
  bin_id          String
  commodity_id    String?
  bushels         Float        @default(0)
  kg              Float        @default(0)
  crop_year       Int?
  notes           String?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  count_period    CountPeriod  @relation(fields: [count_period_id], references: [id], onDelete: Cascade)
  bin             InventoryBin @relation(fields: [bin_id], references: [id], onDelete: Cascade)
  commodity       Commodity?   @relation(fields: [commodity_id], references: [id])

  @@unique([farm_id, count_period_id, bin_id])
  @@map("bin_counts")
}

model Contract {
  id             String     @id @default(uuid())
  farm_id        String
  contract_number String?
  buyer          String
  commodity_id   String
  contracted_mt  Float
  price_per_mt   Float?
  status         String     @default("open") // open, fulfilled, cancelled
  notes          String?
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt
  commodity      Commodity  @relation(fields: [commodity_id], references: [id])
  deliveries     Delivery[]

  @@map("contracts")
}

model Delivery {
  id            String   @id @default(uuid())
  farm_id       String
  contract_id   String
  mt_delivered  Float
  delivery_date DateTime @db.Date
  ticket_number String?
  notes         String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  contract      Contract @relation(fields: [contract_id], references: [id], onDelete: Cascade)

  @@map("deliveries")
}
