generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password_hash String
  name          String
  role          String         @default("farm_manager")
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  farm_roles    UserFarmRole[]

  @@map("users")
}

model Farm {
  id         String         @id @default(uuid())
  name       String
  created_at DateTime       @default(now())
  updated_at DateTime       @updatedAt
  user_roles UserFarmRole[]

  @@map("farms")
}

model UserFarmRole {
  id      String @id @default(uuid())
  user_id String
  farm_id String
  role    String @default("admin")
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  farm    Farm   @relation(fields: [farm_id], references: [id], onDelete: Cascade)

  @@unique([user_id, farm_id])
  @@map("user_farm_roles")
}

model Assumption {
  id           String    @id @default(uuid())
  farm_id      String
  fiscal_year  Int
  start_month  String    @default("Nov")
  end_month    String    @default("Oct")
  total_acres  Float
  crops_json   Json      @default("[]")
  bins_json    Json      @default("[]")
  is_frozen    Boolean   @default(false)
  frozen_at    DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  @@unique([farm_id, fiscal_year])
  @@map("assumptions")
}

model MonthlyData {
  id            String   @id @default(uuid())
  farm_id       String
  fiscal_year   Int
  month         String
  type          String   // 'per_unit' or 'accounting'
  data_json     Json     @default("{}")
  is_actual     Boolean  @default(false)
  comments_json Json     @default("{}")
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([farm_id, fiscal_year, month, type])
  @@map("monthly_data")
}

model MonthlyDataFrozen {
  id            String   @id @default(uuid())
  farm_id       String
  fiscal_year   Int
  month         String
  type          String
  data_json     Json     @default("{}")
  is_actual     Boolean  @default(false)
  comments_json Json     @default("{}")
  created_at    DateTime @default(now())

  @@unique([farm_id, fiscal_year, month, type])
  @@map("monthly_data_frozen")
}

model FinancialCategory {
  id            Int     @id
  code          String  @unique
  display_name  String
  parent_id     Int?
  path          String
  level         Int
  sort_order    Int
  category_type String
  parent        FinancialCategory?  @relation("CategoryParent", fields: [parent_id], references: [id])
  children      FinancialCategory[] @relation("CategoryParent")

  @@map("financial_categories")
}

model QbCategoryMapping {
  id              String @id @default(uuid())
  farm_id         String
  qb_account_name String
  category_code   String
  weight          Float  @default(1.0)

  @@unique([farm_id, qb_account_name])
  @@map("qb_category_mappings")
}

model QbToken {
  id            String   @id @default(uuid())
  farm_id       String   @unique
  access_token  String
  refresh_token String
  realm_id      String
  expires_at    DateTime

  @@map("qb_tokens")
}

model FarmCategory {
  id            String         @id @default(uuid())
  farm_id       String
  code          String
  display_name  String
  parent_id     String?
  path          String
  level         Int
  sort_order    Int
  category_type String         // REVENUE, INPUT, LPM, LBF, INSURANCE
  is_active     Boolean        @default(true)
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt

  parent        FarmCategory?  @relation("FarmCategoryParent", fields: [parent_id], references: [id])
  children      FarmCategory[] @relation("FarmCategoryParent")
  gl_accounts   GlAccount[]

  @@unique([farm_id, code])
  @@map("farm_categories")
}

model GlAccount {
  id             String          @id @default(uuid())
  farm_id        String
  account_number String
  account_name   String
  category_id    String?
  qb_account_id  String?
  is_active      Boolean         @default(true)
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt

  category       FarmCategory?   @relation(fields: [category_id], references: [id])
  actuals        GlActualDetail[]

  @@unique([farm_id, account_number])
  @@map("gl_accounts")
}

model GlActualDetail {
  id            String    @id @default(uuid())
  farm_id       String
  fiscal_year   Int
  month         String
  gl_account_id String
  amount        Float
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  gl_account    GlAccount @relation(fields: [gl_account_id], references: [id])

  @@unique([farm_id, fiscal_year, month, gl_account_id])
  @@map("gl_actual_details")
}

model FarmInvite {
  id         String   @id @default(uuid())
  farm_id    String
  email      String
  role       String   @default("viewer")
  invited_by String
  status     String   @default("pending") // pending, accepted, expired
  created_at DateTime @default(now())
  expires_at DateTime

  @@unique([farm_id, email])
  @@map("farm_invites")
}

model OperationalData {
  id           String   @id @default(uuid())
  farm_id      String
  fiscal_year  Int
  month        String
  metric       String   // 'labour_hours', 'equipment_hours', 'fuel_litres'
  budget_value Float    @default(0)
  actual_value Float    @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([farm_id, fiscal_year, month, metric])
  @@map("operational_data")
}

model AiConversation {
  id         String      @id @default(uuid())
  farm_id    String
  user_id    String
  title      String?
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  messages   AiMessage[]

  @@index([farm_id])
  @@map("ai_conversations")
}

model AiMessage {
  id              String         @id @default(uuid())
  conversation_id String
  role            String         // user, assistant, system
  content         String
  context_json    Json?
  metadata_json   Json?
  created_at      DateTime       @default(now())
  conversation    AiConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@map("ai_messages")
}
